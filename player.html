<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>IPTV 播放器</title>
  <style>
    :root {
      --bg-1: #030711;
      --bg-2: #08132b;
      --accent: #4ae2ff;
      --muted: #9fb6c8;
      --card: #f4fbff;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      min-height: 100vh;
      font-family: "Inter", "HarmonyOS Sans", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      color: var(--card);
      background: #000;
      overflow: hidden;
    }

    .frame-shell {
      position: fixed;
      inset: 0;
      width: 100%;
      height: 100%;
      overflow: hidden;
      background: #000;
    }

    iframe {
      width: 100%;
      height: 100%;
      border: none;
      background: #000;
    }
  </style>
</head>

<body>
  <div class="frame-shell">
    <iframe id="playerFrame" allow="autoplay; encrypted-media; fullscreen; picture-in-picture" allowfullscreen></iframe>
  </div>
  <script type="module">
    import {
      DEFAULT_PLAYER_BASE,
      ENABLE_503_PAGE,
      PAGE_503_PATH,
      ENABLE_501_PAGE,
      PAGE_501_PATH
    } from './config.js';

    const shouldRedirect = (currentPath, targetPage) => {
      const normalizedTarget = targetPage.replace(/^\//, '');
      return !(
        currentPath === `/${normalizedTarget}` ||
        currentPath.endsWith(`/${normalizedTarget}`)
      );
    };

    const redirectIfUnavailable = () => {
      const currentPath = window.location.pathname;
      if (ENABLE_503_PAGE) {
        const queueUrl = new URL(PAGE_503_PATH, window.location.href);
        if (shouldRedirect(currentPath, PAGE_503_PATH)) {
          window.location.replace(queueUrl.toString());
        }
        return true;
      }

      if (ENABLE_501_PAGE) {
        const comingUrl = new URL(PAGE_501_PATH, window.location.href);
        if (shouldRedirect(currentPath, PAGE_501_PATH)) {
          window.location.replace(comingUrl.toString());
        }
        return true;
      }
      return false;
    };

    if (!redirectIfUnavailable()) {
      function buildPlayerSrc(base, url) {
        if (!base) return '';
        const encoded = encodeURIComponent(url);
        if (base.includes('{url}')) return base.split('{url}').join(encoded);
        return base + encoded;
      }

      function isLinuxDesktop() {
        const ua = (navigator.userAgent || '').toLowerCase();
        const isAndroid = ua.includes('android');
        return ua.includes('linux') && !isAndroid;
      }

      const params = new URLSearchParams(window.location.search);
      const streamUrl = params.get('url')?.trim() || '';
      const isLive = params.get('isLive') ?? 'true';
      const playerBase = params.get('player') || params.get('playerPath') || DEFAULT_PLAYER_BASE;

      const frame = document.getElementById('playerFrame');
      const encodedUrl = encodeURIComponent(streamUrl);
      const xgPath = `/xg-player.html?url=${encodedUrl}&isLive=${encodeURIComponent(isLive)}`;
      // 统一使用 Tesla 专用播放器，以解决跨域和格式兼容性问题
      // 原有的本地 xgplayer 无法解决第三方 VOD 的 CORS 问题
      const src = buildPlayerSrc(playerBase, streamUrl);

      // 由于 tesla-kit.com 设置了 X-Frame-Options: SAMEORIGIN，无法在 iframe 中嵌入
      // 必须进行页面跳转
      if (src) {
        // 提供交互式跳转，防止被浏览器拦截或因时序问题导致白屏
        document.body.innerHTML = `
          <div style="display:flex;flex-direction:column;align-items:center;justify-content:center;height:100vh;background:#000;color:white;font-family:sans-serif;">
            <div style="font-size:20px;margin-bottom:20px;">Ready to Play</div>
            <a href="${src}" id="playLink" style="padding:15px 30px;background:#4ae2ff;color:#000;text-decoration:none;border-radius:8px;font-weight:bold;font-size:18px;">立即播放 / Play Now</a>
            <div style="margin-top:20px;color:#666;font-size:14px;">If not redirected automatically, click the button above.</div>
            <div id="debuginfo" style="margin-top:20px;color:red;font-size:12px;display:none;"></div>
          </div>
        `;

        // 尝试自动跳转 (延迟3秒，确保用户也能看到界面)
        setTimeout(() => {
          try {
            window.location.href = src;
          } catch (e) {
            document.getElementById('debuginfo').style.display = 'block';
            document.getElementById('debuginfo').innerText = 'Auto-redirect failed: ' + e.message;
          }
        }, 3000);
      }
    }
  </script>
  <script defer src="https://static.cloudflareinsights.com/beacon.min.js/vcd15cbe7772f49c399c6a5babf22c1241717689176015"
    integrity="sha512-ZpsOmlRQV6y907TI0dKBHq9Md29nnaEIPlkf84rnaERnq6zvWvPUqr2ft8M1aS28oN72PdrCzSjY4U6VaAw1EQ=="
    data-cf-beacon='{"version":"2024.11.0","token":"d722d971986142e4ae3477d859fe7006","r":1,"server_timing":{"name":{"cfCacheStatus":true,"cfEdge":true,"cfExtPri":true,"cfL4":true,"cfOrigin":true,"cfSpeedBrain":true},"location_startswith":null}}'
    crossorigin="anonymous"></script>
  <script>(function () { function c() { var b = a.contentDocument || a.contentWindow.document; if (b) { var d = b.createElement('script'); d.innerHTML = "window.__CF$cv$params={r:'9c46a24f1919c4f3',t:'MTc2OTQ5OTk2Mg=='};var a=document.createElement('script');a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);"; b.getElementsByTagName('head')[0].appendChild(d) } } if (document.body) { var a = document.createElement('iframe'); a.height = 1; a.width = 1; a.style.position = 'absolute'; a.style.top = 0; a.style.left = 0; a.style.border = 'none'; a.style.visibility = 'hidden'; document.body.appendChild(a); if ('loading' !== document.readyState) c(); else if (window.addEventListener) document.addEventListener('DOMContentLoaded', c); else { var e = document.onreadystatechange || function () { }; document.onreadystatechange = function (b) { e(b); 'loading' !== document.readyState && (document.onreadystatechange = e, c()) } } } })();</script>
</body>

</html>